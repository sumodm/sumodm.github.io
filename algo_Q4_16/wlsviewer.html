<!DOCTYPE html>
<html style="margin:0px; padding:0px; height:100%; overflow:hidden;">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
		<meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<title>WebLectureScribe Viewer</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
		<style>
         .stopSelect{
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
             user-select: none;
            }
       </style>
	</head>
	<body style="padding:0px; margin:0px; height:100%; overflow:hidden;">
		<img id="pointerImg" src="data:image/png;base64,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" hidden>
		<div id="container" style="background-color:white; width:100%; height:100%; overflow:hidden; z-index:0;">
			<div id="pointerDiv" style="position:fixed; z-index:1; pointer-events:none;" hidden>
				<canvas id="pointerCanvas" style="padding:0px; margin:0px; border:0px;"></canvas>
			</div>
			<div id="volumeDiv" height="100px" width="40px" style="position:fixed; background-color:#444; z-index:10;" hidden>
				<canvas id="volumeCanvas" height="100px" width="40px" style="padding:0px; margin:0px; border:0px;"></canvas>
			</div>
			<div id="hideError" hidden>
				<div id="errorDiv" class="stopSelect" style="font-family:Arial,Helvetica,sans-serif; font-size:18px; display:table; background-color:#fee; color:#a00; overflow:hidden;">
					<div style="display:table-cell; vertical-align:middle;">
						<div id="errorText" style="text-align:center;">
						</div>
					</div>
				</div>
			</div>
			<div id="canvasDiv">
				<div id="captionDiv" style="font-family:Arial,Helvetica,sans-serif; font-size:24px; width:100%; text-align:center; position:absolute; bottom:30px; z-index:3; pointer-events:none; color:#ffa;" hidden>
					<div style="display:inline-block; padding:6px; background-color:rgba(0,0,0,0.75);"><div id="captionText"></div></div>
				</div>
				<canvas id="myCanvas" style="padding:0px; padding-bottom:1px; margin:0px; border:0px; vertical-align:top; display:block; overflow:hidden;"></canvas>
			</div>
			<div id="myFooter" class="stopSelect" style="font-family:Arial,Helvetica,sans-serif; font-size:12px; display:table; background-color:#444; color:#eee; height:20px; width:100%; overflow:hidden;">
				<div style="display:table-cell; vertical-align:middle;">
					<div>
						<span style="float:left;" id="audioContainer">
							<img id="loadImg" src="data:image/gif;base64,R0lGODlhEAAQAPQAAERERO7u7kdHR8fHx5WVlenp6dTU1F5eXnx8fN7e3p6enqmpqVVVVYeHh2lpab29vbS0tAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH+GkNyZWF0ZWQgd2l0aCBhamF4bG9hZC5pbmZvACH5BAAKAAAAIf8LTkVUU0NBUEUyLjADAQAAACwAAAAAEAAQAAAFUCAgjmRpnqUwFGwhKoRgqq2YFMaRGjWA8AbZiIBbjQQ8AmmFUJEQhQGJhaKOrCksgEla+KIkYvC6SJKQOISoNSYdeIk1ayA8ExTyeR3F749CACH5BAAKAAEALAAAAAAQABAAAAVoICCKR9KMaCoaxeCoqEAkRX3AwMHWxQIIjJSAZWgUEgzBwCBAEQpMwIDwY1FHgwJCtOW2UDWYIDyqNVVkUbYr6CK+o2eUMKgWrqKhj0FrEM8jQQALPFA3MAc8CQSAMA5ZBjgqDQmHIyEAIfkEAAoAAgAsAAAAABAAEAAABWAgII4j85Ao2hRIKgrEUBQJLaSHMe8zgQo6Q8sxS7RIhILhBkgumCTZsXkACBC+0cwF2GoLLoFXREDcDlkAojBICRaFLDCOQtQKjmsQSubtDFU/NXcDBHwkaw1cKQ8MiyEAIfkEAAoAAwAsAAAAABAAEAAABVIgII5kaZ6AIJQCMRTFQKiDQx4GrBfGa4uCnAEhQuRgPwCBtwK+kCNFgjh6QlFYgGO7baJ2CxIioSDpwqNggWCGDVVGphly3BkOpXDrKfNm/4AhACH5BAAKAAQALAAAAAAQABAAAAVgICCOZGmeqEAMRTEQwskYbV0Yx7kYSIzQhtgoBxCKBDQCIOcoLBimRiFhSABYU5gIgW01pLUBYkRItAYAqrlhYiwKjiWAcDMWY8QjsCf4DewiBzQ2N1AmKlgvgCiMjSQhACH5BAAKAAUALAAAAAAQABAAAAVfICCOZGmeqEgUxUAIpkA0AMKyxkEiSZEIsJqhYAg+boUFSTAkiBiNHks3sg1ILAfBiS10gyqCg0UaFBCkwy3RYKiIYMAC+RAxiQgYsJdAjw5DN2gILzEEZgVcKYuMJiEAOwAAAAAAAAAAAA==" style="vertical-align:middle; height:20px;">
							<img id="playImg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACEAAAAcCAYAAADvANYcAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAEKSURBVEhL3ZZhDoMgDEaFs+mpvZssOL6kq7SF0mXJ3p+BxPZRZjXt+162H5Pb7zSlxLmrlTjPs43WOY6jjZ6IlYgUqGjxupWgN2g7GMWK96iER8D6f9A4vYqIx8EF6s29AFUgpdRmMtqGpp8OLlMFVp8U9yNKZUYqoeGWALwyHpYlwIpMmATwyIRLgBmZr0nM8N8StTmNdtxwiZnkIEzCkxwsS6wkB26JiORgWiIyORAleKOxkltvUq1xPSRoIqvj0cTam5TG6W1E/NAdbbkzSJUUj0MrvQct3l2J0U80C8Th8az5XQlcqIsUOr+uq41kEIfHs+Yfx1EXuQjIOd9r0noPHg/JwXu9bC9OGJkiG9bKuwAAAABJRU5ErkJggg==" onclick="handleKeyPress(32);" style="cursor:pointer; vertical-align:middle; height:20px;" hidden>
							<img id="pauseImg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACEAAAAcCAYAAADvANYcAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAADZSURBVEhL7ZfhDoMgDISFZ4On5t1kKeMSBm1B1mT7wZcYwep5HhrQhRDy9WN83T8mZzvvahIppdr6nhhjbY2ISVgaIDQ9Non2Au0JVpnpDUlYGyBaHS4RcTisDABNb/nroCdoN46Vczi2P1FLjglwTIBjAhwT4JgAf2FiWE9g4rGeRQlJW0ziySy4gqY3mJgtQHZodbiExYWudRKENMTicFi/E5peSYL+IZxz9dA+0On1Zv2SBA5QsaXt3/ddWzLQ6fVm/Y/hoGJvBHjvS02qc/R6uDl41/P1AjxeeXepl3xvAAAAAElFTkSuQmCC" onclick="handleKeyPress(32);" style="cursor:pointer; vertical-align:middle; height:20px;" hidden>
							<canvas id="progressBar" height="20px" width="100px" style="cursor:pointer; padding:0px; margin:0px; border:0px; vertical-align:middle; overflow:hidden;" hidden></canvas>
							<audio id="audioControl" style="padding:0px; width:0px;" hidden></audio>  
							<span id="loadingVideoSpan">Initializing...</span>
						</span>
						<span id="rightSpan" style="float:right;">  
							<span id="disableWhileLoadingVideo" hidden>
								<span id="clockBlock">
									<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAgCAYAAAArBentAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsIAAA7CARUoSoAAAAA8SURBVDhPY3RxcfnPAAUpKSkMjx49ArOfPn3KcPXqVTAbBJigNEEwqhAvGFWIF4wqxAtGFeIF1FbIwAAAJmkLC+Q7dwUAAAAASUVORK5CYII=" style="vertical-align:middle; height:20px;">
									<span id="clockSpan">
									</span>
								</span>
								<span id="muteBlock">
								<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAgCAYAAAArBentAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsIAAA7CARUoSoAAAAA8SURBVDhPY3RxcfnPAAUpKSkMjx49ArOfPn3KcPXqVTAbBJigNEEwqhAvGFWIF4wqxAtGFeIF1FbIwAAAJmkLC+Q7dwUAAAAASUVORK5CYII=" style="vertical-align:middle; height:20px;">
								<img id="muteImg" title="Volume: 100%" onclick="toggleVolumeControl();" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAAcCAYAAACDBoQZAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAADkSURBVEhLrZOBDsMgCETVb9Ov9uO2nSuNpQfo1pc02gjnAW2utb4+pJxz+pdyrI8wxMQVHEZ4MdTZiihju0yvt8/3TLBu7b0fO5/QGROyxKmYOLSSWmv0rFiTi0pjggUuIIgHh7Jq5hiLUSYEvZEDiZkdaXe3nkWiHuE0dzAH8AvDmTTXYyXmVmaUgIaj8XoPLmJyMAdovDNzAF4S0K6AO01LkAkBVwywJOuS8TsBrFbzJTn6oIezWdASjYRAWOYO9A9YccEYziAYfawsRr+fPYvc6F5iLzly0VLPzuDCw79mcnoD9guL+hyLOZoAAAAASUVORK5CYII=" style="cursor:pointer; vertical-align:middle; height:20px;">
								</span>
							</span>
							<span id="prevBlock" hidden>
								<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAgCAYAAAArBentAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsIAAA7CARUoSoAAAAA8SURBVDhPY3RxcfnPAAUpKSkMjx49ArOfPn3KcPXqVTAbBJigNEEwqhAvGFWIF4wqxAtGFeIF1FbIwAAAJmkLC+Q7dwUAAAAASUVORK5CYII=" style="vertical-align:middle; height:20px;">
								<span id="prevSpan" title="Go back to previous video" style="cursor:pointer;">
									<img id="prevImg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAcCAYAAACOGPReAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAC2SURBVEhLvZVBDsMgDAQNb+NfwMvbLoJIbR28GNq5BFAyrI0UQkrp8UJCCHKK2J9HadKREoktmHd+lxSwfS2lSM65z3QuKSO0ZAO6fFYIKOmKEJjSVSGYSj1CcCv1CoEq3RGCL+muEJgH5eE/0lprH/lRk+6Kb8vfEU976hWbB+URR+ZPviqO7IW3Ir7KP5m4XdEYsNcJQ+vpSSEwT3+G1jKsNakn5Wd1YwOsUUnxgZZq8L6ByBM/PU67XsfIQgAAAABJRU5ErkJggg==" style="vertical-align:middle; height:20px;">
									<span id="prevText">Previous</span>
								</span>
							</span>
							<span id="asBlock">
								<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAgCAYAAAArBentAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsIAAA7CARUoSoAAAAA8SURBVDhPY3RxcfnPAAUpKSkMjx49ArOfPn3KcPXqVTAbBJigNEEwqhAvGFWIF4wqxAtGFeIF1FbIwAAAJmkLC+Q7dwUAAAAASUVORK5CYII=" style="vertical-align:middle; height:20px;">
								<span id="asSpan" title="Auto-Scroll is currently ON" style="cursor:pointer;">
									<img id="asImg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAAcCAYAAABsxO8nAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAACcSURBVEhL1ZThCoAgDIRVejTfS3zyhTBL1nZKWdj9UTfuQ2+RjzGSm6DA62N9B0op8Q4LgipkBGaCpLkHU0GWCcE2Xi/KOfPuFAKt9x3BG7VP0Z7aar2pTcvoXZAVLArcvJE09ab2kx/bnfGrT0MGK6v1pgbDruYepEjNiIic955PYwrFJNVCtL5WC8gkb1b7Wu3ISJqktP5Zc24HmstXZXSes3kAAAAASUVORK5CYII=" style="vertical-align:middle; height:20px;">
									<img id="nasImg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAAcCAYAAABsxO8nAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAADOSURBVEhLxZRhDsMgCIXV7Gjeq/FsHsyFRSylD6px2b4/oygvDzCLOecWvkDqv9v8Tug4jh75uDOSIqWUHl3hO6Yj7QQ5kzkohIoImZcxuX31+AZqhYu1CLH8jpAIsbR+S4SY3poEtT29NQaJEEtb81iakcd/hKz5EDeh1SEzl/V77+SJ4WhHhPgIaRGrPStPxFrraI2deAWW29GavGBdtvLE9j8k474jLn4SIaCj1lqIMfavORIVaaQIOke55BVpZ3yOcmNGukiDzs9cCG9eM3R2U9FgBwAAAABJRU5ErkJggg==" style="vertical-align:middle; height:20px;" hidden>
									<span id="asText">Auto-Scroll</span>
								</span>
							</span>
							<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAgCAYAAAArBentAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsIAAA7CARUoSoAAAAA8SURBVDhPY3RxcfnPAAUpKSkMjx49ArOfPn3KcPXqVTAbBJigNEEwqhAvGFWIF4wqxAtGFeIF1FbIwAAAJmkLC+Q7dwUAAAAASUVORK5CYII=" style="vertical-align:middle; height:20px;">
							<img id="ccImg" onclick="toggleCaptions();" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACIAAAAcCAYAAAAEN20fAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsIAAA7CARUoSoAAAAHHSURBVEhLzZYvTAJRHMe/x8Qg5QoUyhXLGSRDwA0sWEwGi25gUTfHJsW5IRsjODdnOIrHpsWgyUKxQNBCOYIUk4EixYIBw8nTd46D+/Pb5A4/F97d++3efe/73n6/n5BOp3VwdF2HIAj8yV8CfPQF9qN2mIQYbji98Bec1vfVESdMZ4RhqK3Vat/jtMnlcpZnUUilUvropKqq/M47stnshJCZbI2V2yZHxt1gNk4Tp/UDdid52iIYbEvsmOMjgWVsFXewuhTBPAZ4e35ACzFIrTxKdUrcGeIZkbF7XsCa9I6GUsDGRh7VlygSiyIx7g5NSHIdsegHtKtjqM3X4UQPnZsKFK0PUSLECZCExBMSxH4XWpNPcNpn+8hX3eMUSELEYJDfWeMWpzCTPGIFSUhd62IQiiKW5BOc8GYZpweya5wCzZH7Ozx1FxDbLiOXlBEeXnLmEMX4JxoXHfc4AeLWtFGtXOOxF8HK3gmUWwVHmRBalyX8pAi3uDu/1Zdl1tEa4EVmdfqGrSNeVGGn1sLkCKs7frQBjHHHA0axG+8PvMSq+E00Rl47w5wwvjGKrRC/MfUjXotg69vxP1P8LLbEwFdH7H8U+ALIHt5p4FC/FAAAAABJRU5ErkJggg==" style="cursor:pointer; vertical-align:middle; height:20px;">							 
							<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAgCAYAAAArBentAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsIAAA7CARUoSoAAAAA8SURBVDhPY3RxcfnPAAUpKSkMjx49ArOfPn3KcPXqVTAbBJigNEEwqhAvGFWIF4wqxAtGFeIF1FbIwAAAJmkLC+Q7dwUAAAAASUVORK5CYII=" style="vertical-align:middle; height:20px;">
							<img id="fsImg" title="Toggle full-screen mode" onclick="handleKeyPress(70);" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACIAAAAcCAYAAAAEN20fAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsIAAA7CARUoSoAAAAFfSURBVEhLzZUNcoQwCIWTXE1vosfSq9r2ZcIushCIXbv9ZtoxfwQIj83zPH/9kHLO6VMcx5FK+74VBOpRHaFsRA5cwbNfSkn1adq4btz3vY101nVtX0+2bWtfOnSmVwKPp4lkQ3MCWPMjhGuER6XxW2dOjnjKiWTtCkOqseqAnPPqBPQCLTCEPy8bAIWs7fOciGTSzAjefFmWNnoiL9VUhrOjNVMQoYySjGBeGhwZy7Uepz5igdQicsswrSOD2tN5T49iDTsCyJg0TOvgqiNh1dzNQzWfJpwRrg7+RJR2TT0jvDii9QS6xOoXNK854/UYQs0IPywN8bGWid7ZHnmaploglG7vsCZh74wla2JYNVYfGWlcFtWRnreE1u453rpHbfHgThnzOyxOT9PLjCfPt8u3B4pSRoVxVB29QF9Uw8ElfF6OwZU9kv/1W4N/lrc0j4isqCJ7IvxJRnznUvoGc5Th4SsrLqoAAAAASUVORK5CYII=" style="cursor:pointer; vertical-align:middle; height:20px;">							 
						</span>
					</div>
				</div>
			</div>
		</div>
<script>
// From jquery.ajaxprogress.js:

(function($, window, undefined) {
    //is onprogress supported by browser?
    var hasOnProgress = ("onprogress" in $.ajaxSettings.xhr());

    //If not supported, do nothing
    if (!hasOnProgress) {
        return;
    }
    
    //patch ajax settings to call a progress callback
    var oldXHR = $.ajaxSettings.xhr;
    $.ajaxSettings.xhr = function() {
        var xhr = oldXHR();
        if(xhr instanceof window.XMLHttpRequest) {
            xhr.addEventListener('progress', this.progress, false);
        }
        
        if(xhr.upload) {
            xhr.upload.addEventListener('progress', this.progress, false);
        }
        
        return xhr;
    };
})(jQuery, window);

// Global data ------

var browserIsIos = false;

var stateStack = [];

var canvasFull, contextFull;
var curDrawRequest = false, drawCmds = false, audioLoaded = false, refCmds = [], transcript = [];
var curDrawIdx = 0, scrollY=0, maxY;
var pointerLastTime, pointerLastX, pointerLastY;

var dragging = false, clickX, clickY, drawReset = false, canvasMove = false, animStart = -1, animRef;
var canvasScreen, contextScreen, audioLoaded = false, audioMetaDataLoaded = false, videoPctLoaded = -1;
var draggingAudio = false, pausedBeforeDragging = false, draggingVolume = false;
var canvasAudio, contextAudio;

var refSize = 0.05;
var pointerImg, pointerCanvas, pointerDiv, volumeCanvas, volumeDiv, captionDiv, captionText;
var audioControl, volumeDivTime, captionMode = false, captionTime = -10, captionSize = 28; captionsAvailable = false;

// -------------------

function setErrorMode(msg)
{
	$("#errorText")[0].innerHTML = "<h3>Error</h3>" + msg;
	$("#loadImg")[0].hidden = true;
	$("#loadingVideoSpan")[0].innerHTML = "";
	$("#hideError")[0].hidden = false;
	$("#canvasDiv")[0].hidden = true;	
}

function clearErrorMode()
{
	$("#canvasDiv")[0].hidden = false;
	$("#hideError")[0].hidden = true;
}

function clockNow() 
{
   return new Date().getTime() / 1000.0;
}

function getCurrentTime()
{
    return audioControl.currentTime || 0;
}

function toggleFullScreen() {
  if (!document.fullscreenElement &&    // alternative standard method
      !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement ) {  // current working methods
    if (document.documentElement.requestFullscreen) {
      document.documentElement.requestFullscreen();
    } else if (document.documentElement.msRequestFullscreen) {
      document.documentElement.msRequestFullscreen();
    } else if (document.documentElement.mozRequestFullScreen) {
      document.documentElement.mozRequestFullScreen();
    } else if (document.documentElement.webkitRequestFullscreen) {
      document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
    }
  } else {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.msExitFullscreen) {
      document.msExitFullscreen();
    } else if (document.mozCancelFullScreen) {
      document.mozCancelFullScreen();
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    }
  }
}
 
function focusY(c)
{
	if (c.type == "image") return c.y + c.ys/2;
	if (c.type == "pointer") return c.y;
	if (c.type == "eyeball") return c.y;
	if (c.type == "line") return (c.y1 + c.y2) / 2;
	if (c.type == "ychange") return c.y;
}

function drawRef(x, y, sx, sy, toScreen)
{
	var W = canvasScreen.width;
	var ctx = toScreen ? contextScreen : contextFull;
	ctx.save();
	var grd=ctx.createLinearGradient(x,y,x+sx*2,y+sy*2);
	grd.addColorStop(0,"black");
	grd.addColorStop(1,"white");
	ctx.fillStyle=grd;
	ctx.fillRect(x,y,sx,sy);
	ctx.fillStyle = "#aaf";
	ctx.beginPath();
	ctx.moveTo(x+sx*0.15, y+sy*0.15);
	ctx.lineTo(x+sx*0.15, y+sy*0.85);
	ctx.lineTo(x+sx*0.85, y+sy*0.5);	
	ctx.closePath();
	ctx.fill();
	ctx.restore();
}

function render(c, toScreen)
{
	var W = canvasScreen.width;
	var ctx = toScreen ? contextScreen : contextFull;
	var offsetY = toScreen ? scrollY : 0;
	
	if (c.type == "line") {
		ctx.beginPath();
		ctx.lineCap = "round";
		ctx.lineJoin = "round";
		ctx.strokeStyle = c.color;
		ctx.lineWidth = Math.max(1,c.width * W / 700);
		ctx.moveTo(c.x1 * W, c.y1 * W - offsetY);
		ctx.lineTo(c.x2 * W, c.y2 * W - offsetY);
		ctx.stroke();
	}
	if (c.type == "pointer" && toScreen && !audioControl.paused) {
		pointerLastX = c.x;
		pointerLastY = c.y;
		pointerLastTime = c.ltime;
		pointerDiv.style.left = (c.x * W) + "px";
		pointerDiv.style.top = (c.y * W - offsetY) + "px";
		pointerDiv.hidden = false;
	}
	if (c.type == "image")
		ctx.drawImage(c.data, 0, 0, c.data.width, c.data.height, c.x*W, c.y*W - offsetY, c.xs*W, c.ys*W);
	if (c.type == "reference") 
		drawRef(c.x * W, c.y * W - offsetY, refSize*W, refSize*W, toScreen);
	if (c.type == "nocaption" && captionMode) 
		captionDiv.hidden = true;
	if (c.type == "caption" && captionMode) {
		captionText.innerHTML = c.text;
		captionDiv.hidden = false;
	}
}

function clockify(t)
{
	t = Math.round(t);
	m = Math.floor(t / 60);
	s = '' + (t - m * 60);
	while (s.length < 2) s = '0' + s;
	return m + ":" + s;
}

function drawAudio()
{
	var currentTime = getCurrentTime();
	var duration = audioControl.duration;
	canvasAudio.width = canvasScreen.width - $("#rightSpan").width() - $("#playImg").width() - 8;
	var W = canvasAudio.width, H = canvasAudio.height;
	if (duration) {
	var loaded = audioControl.buffered.end(audioControl.buffered.length-1);
	contextAudio.fillStyle = "#aaa";
	contextAudio.fillRect(0, H * 0.4, W*loaded/duration, H*0.2);
	}
        contextAudio.strokeStyle = "#eee";
	contextAudio.beginPath();
	contextAudio.moveTo(0, H * 0.4);
	contextAudio.lineTo(W, H * 0.4);
	contextAudio.lineTo(W, H * 0.6);
	contextAudio.lineTo(0, H * 0.6);
	contextAudio.lineTo(0, H * 0.4);
	contextAudio.stroke();
	if (audioLoaded && duration) {
		$("#clockSpan")[0].innerHTML = clockify(currentTime) + " / " + clockify(audioControl.duration);
		$("#pauseImg")[0].hidden = audioControl.paused;
		$("#playImg")[0].hidden = !audioControl.paused;
		var x = Math.round((W-10) * currentTime / duration);
		contextAudio.fillStyle = "#000"; contextAudio.fillRect(x, H * 0.2, 10, H*0.6);
		contextAudio.fillStyle = "#eee"; contextAudio.fillRect(x+1, H * 0.2+1, 8, H*0.6-2);
	} else {
		$("#clockSpan")[0].innerHTML = "Buffering audio...";
	}
}

function eventAudioPause() 
{
	$("#pauseImg")[0].hidden = true;
	$("#playImg")[0].hidden = false;
}

function eventAudioPlay() 
{
	$("#pauseImg")[0].hidden = false;
	$("#playImg")[0].hidden = true;
}

function draw()
{
	if (!drawCmds || !audioLoaded) return;
	
	if (draggingAudio) return;
	
	if (animStart > 0) {
		var now = clockNow(), W = canvasScreen.width;
		var animTime = 0.25;
		if (now - animStart > animTime) {
			contextScreen.clearRect(0, 0, canvasScreen.width, canvasScreen.height);
			launch(animRef.target);
			return;
		}
		var x1 = animRef.x * W, y1 = animRef.y * W - scrollY, x2 = (animRef.x + refSize) * W, y2 = (animRef.y + refSize) * W - scrollY;
		var lambda = (now - animStart) / animTime;
		drawRef(x1 * (1-lambda), y1 * (1-lambda), 
				(x2-x1) * (1-lambda) + canvasScreen.width * lambda,
				(y2-y1) * (1-lambda) + canvasScreen.height * lambda,
				true);
		window.requestAnimationFrame(draw);
		return;
	}
	
	var currentTime = getCurrentTime();
	
	if (audioLoaded) drawAudio();
	
	// anything disappear during this window?  If so, invoke wholesale redraw...
	if (!drawReset) {
		var i = curDrawIdx;
		while (i < transcript.length && transcript[i].time <= currentTime) {
			if (drawCmds[transcript[i].idx].utime <= currentTime) drawReset = true;
			i++;
		}
	}
		
	if (drawReset) {
		contextScreen.clearRect(0, 0, canvasScreen.width, canvasScreen.height);
		contextFull.clearRect(0, 0, canvasFull.width, canvasFull.height);
		curDrawIdx = 0;
		drawReset = false;
		canvasMove = false;
		pointerLastTime = -1;
	} else if (canvasMove) {
		contextScreen.clearRect(0, 0, canvasScreen.width, canvasScreen.height);
		contextScreen.drawImage(canvasFull, 0, scrollY, canvasScreen.width, canvasScreen.height, 
									0, 0, canvasScreen.width, canvasScreen.height);
		if (!pointerDiv.hidden) { 
			pointerDiv.style.left = pointerLastX * canvasScreen.width + "px";
			pointerDiv.style.top = (pointerLastY * canvasScreen.width - scrollY) + "px";
		}
		canvasMove = false;
	}
	var lastFocusY = -1;
	while (curDrawIdx < transcript.length && transcript[curDrawIdx].time <= currentTime) {
		c = drawCmds[transcript[curDrawIdx].idx];
		if (c.utime > currentTime) {
			render(c, false);
			render(c, true);
			lastFocusY = focusY(c);
		}
		curDrawIdx++;
	}
	if (lastFocusY != -1 && $("#nasImg")[0].hidden && !dragging) {
		var relToScreen = (lastFocusY * canvasScreen.width - scrollY) / canvasScreen.height;
		if (relToScreen < 0.2 || relToScreen > 0.8) {
			var oldScrollY = scrollY;
			var newFrac = relToScreen < 0.2 ? 0.2 : 0.8;
			scrollY = lastFocusY * canvasScreen.width - canvasScreen.height * newFrac;
			if (scrollY > canvasFull.height - canvasScreen.height) scrollY = canvasFull.height - canvasScreen.height;
			if (scrollY < 0) scrollY = 0;
			if (oldScrollY != scrollY) 
				canvasMove = true;
		}	
	}
	
	if (!pointerDiv.hidden && pointerLastTime + 0.25 < currentTime)
		pointerDiv.hidden = true;
}

function getUrlVars(s)
{
    var vars = [], hash;
    var hashes = s.slice(s.indexOf('?') + 1).split('&');
    for(var i = 0; i < hashes.length; i++)
    {
        hash = hashes[i].split('=');
        vars.push(hash[0]);
        vars[hash[0]] = hash[1];
    }
    return vars;
}

function getMaxY(c)
{
	if (c.type == "line") return Math.max(c.y1, c.y2);
	if (c.type == "pointer") return c.y;
	if (c.type == "eyeball") return c.y;
	if (c.type == "image") return c.y + c.ys;
	return 0;
}

function compare(a, b)
{
	if (a.time < b.time) return -1;
	if (a.time > b.time) return 1;
	return 0;
}

function createTranscript()
{
	transcript = [];
	captionsAvailable = false;
	for (var i=0; i<drawCmds.length; i++) {
		c = drawCmds[i];
		if (c.type == "caption") {
			captionsAvailable = true;
			if (drawCmds[i].utime < 3600 * 999) drawCmds[i].utime -= 0.001;
		} else {
			transcript.push( { time: c.ltime, idx: i } );
			if (c.utime < 3600 * 999) transcript.push( { time: c.utime, idx: i } );
		}
	}
	$("#ccImg")[0].title = captionsAvailable ? "Toggle closed captioning" : "Closed captioning not available for this video";
	transcript.sort(compare);
	var len = transcript.length;
	for (var i=0; i<len-1; i++) {
		if (transcript[i+1].time - transcript[i].time > 1) {
			for (var j=0; j<10; j++) {
				var fromY = focusY(drawCmds[transcript[i].idx]);
				var toY = focusY(drawCmds[transcript[i+1].idx]);
				var toT = transcript[i+1].time;
				drawCmds.push({type: "ychange", ltime: toT-1+0.1*j, utime:3600*999, y:fromY+(toY-fromY)*j/10});
				transcript.push({time:toT-1+0.1*j, idx:drawCmds.length-1});
			}
		}
	}
	for (var i=0; i<drawCmds.length; i++) {
		c = drawCmds[i];
		if (c.type == "caption") {
			transcript.push({time: c.ltime, idx:i});
			if (c.utime < 3600 * 999) {
				drawCmds.push({type:"nocaption", ltime:c.utime, utime:3600*999});
				transcript.push({time: c.utime, idx: drawCmds.length-1});
			}
		} 
	}
	transcript.sort(compare);
}

function unCompressDrawCmds(oldDC)
{
	var newDC = [];
	for (var i=0; i<oldDC.length; i++) {
		c = oldDC[i];
		if (c.t == 0)
			newDC.push( {type:"pointer", ltime:c.l, utime:3600*999, x:c.x, y:c.y });
		if (c.t == 1)
			newDC.push( {type:"eyeball", ltime:c.l, utime: 3600*999, x:c.x, y:c.y } );
		if (c.t == 2) {
			var img = new Image();
			img.src = c.data;
			newDC.push( {type:"image", ltime:c.l, utime:3600*999, x:c.x, y:c.y, xs:c.xs, ys:c.ys, data:img } );
		}
		if (c.t == 3)
			newDC.push( {type:"reference", ltime:c.l, utime:3600*999, x:c.x, y:c.y, target:c.target} );
		if (c.t == 4)
			newDC.push( {type:"caption", ltime:c.l, utime:3600*999, text:c.text} );
		if (c.t >= 10)
			newDC.push( {type:"line", width:c.t-10, ltime:c.l, utime:3600*999, color:c.c, x1:c.x1, y1:c.y1, x2:c.x2, y2:c.y2, stroke:c.s} );
		if (c.u) newDC[newDC.length-1].utime = c.u;
	}
	return newDC;
}

// Loaded video and metadata
function phaseTwoLoading()
{	 
	$("#progressBar")[0].hidden = false;
	$("#disableWhileLoadingVideo")[0].hidden = false;
	$("#loadingVideoSpan")[0].hidden = true;
	$("#asBlock")[0].hidden = canvasFull.height < canvasScreen.height;
	window.requestAnimationFrame(drawAudio);
}

function phaseThreeLoading()
{
	$("#loadImg")[0].hidden = true;	
	audioControl.play();
}

function loadedVideoData(data)
{
	maxY = 0;
	curDrawRequest = false;
	drawCmds = unCompressDrawCmds(JSON.parse(data));
	refCmds = [];
	for (var i=0; i<drawCmds.length; i++) {
		maxY = Math.max(maxY, getMaxY(drawCmds[i]));
		if (drawCmds[i].type == "reference") refCmds.push(i);
	}
	maxY = maxY * 1.02;
	canvasFull = document.createElement('canvas');
	canvasFull.width = canvasScreen.width;
    canvasFull.height = maxY * canvasScreen.width;
    contextFull = canvasFull.getContext("2d");
	contextFull.lineCap = "round";
	contextFull.lineJoin = "round";
	createTranscript();
	if (audioMetaDataLoaded) 
		phaseTwoLoading();
	else {
		$("#loadingVideoSpan")[0].innerHTML = "Video loaded.";
		$("#loadingVideoSpan")[0].hidden = false;
	}
	if (audioLoaded) phaseThreeLoading(); 
}

function eventAudioLoadedMetaData()
{
	audioMetaDataLoaded = true;
	if (drawCmds) phaseTwoLoading();
}

function eventAudioCanPlayThrough(e)
{
	if (audioLoaded) return;
	if (drawCmds) 
		phaseThreeLoading();
	else
		$("#loadingVideoSpan")[0].innerHTML = "Audio loaded.  Loading video data...";		
	audioLoaded = true;
}

function tick() 
{
	if (!volumeDiv.hidden && clockNow() - volumeDivTime > 5) volumeDiv.hidden = true;
	if (canvasMove || drawReset || (drawCmds && audioLoaded && !audioControl.paused))
		window.requestAnimationFrame(draw);
	if (drawCmds && audioMetaDataLoaded && !audioLoaded)
		window.requestAnimationFrame(drawAudio);
	if (captionTime > 0 && clockNow() - captionTime > 2) {
		captionTime = -10;
		captionDiv.hidden = true;
	}
}

function eventAudioSeeked(e) 
{
	drawReset = true;
}

function eventCanvasMouseUp(e)
{
	e.preventDefault();
	dragging = false;
}

function followRef(c)
{
	animRef = c;
	animStart = clockNow();
	window.requestAnimationFrame(draw);
}

function eventCanvasMouseDown(e)
{
	if (!volumeDiv.hidden) volumeDiv.hidden = true;
	if (draggingAudio) return;
	var rect = canvasScreen.getBoundingClientRect();
	var W = canvasScreen.width;
	var currentTime = getCurrentTime();
	clickX = e.pageX - rect.left;
	clickY = e.pageY - rect.top;
//	$("#debugDiv")[0].innerHTML += "<br>click: " + clickX + " " + clickY;
	e.preventDefault();
	for (var i=0; i<refCmds.length; i++) {
		var c = drawCmds[refCmds[i]];
		if (c.ltime <= currentTime && c.utime > currentTime &&
			clickX / W > c.x && clickX / W < c.x + refSize &&
		    (clickY + scrollY) / W > c.y && (clickY + scrollY) / W < c.y + refSize) {
				followRef(c); 
				return;
		}
	}
	dragging = true;
}

function disableAutoscroll()
{
	$("#asImg")[0].hidden = true;
	$("#nasImg")[0].hidden = false;	
	$("#asSpan")[0].title = "Auto-Scroll is currently OFF";
}

function eventCanvasMouseMove(e)
{
	if (draggingAudio) return;
	var rect = canvasScreen.getBoundingClientRect();
	var mouseX = e.pageX - rect.left, mouseY = e.pageY - rect.top;
	e.preventDefault();
	if (!dragging) return;
	if (mouseX == 0 && mouseY == 0 && Math.max(clickX,clickY) > 10) return; // android hack -- otherwise we get spurious (0,0) moves
//		$("#debugDiv")[0].innerHTML += "<br>move: " + mouseX + " " + mouseY;
	var oldScrollY = scrollY;
	scrollY += clickY - mouseY;
	if (scrollY > canvasFull.height - canvasScreen.height) scrollY = canvasFull.height - canvasScreen.height;
	if (scrollY < 0) scrollY = 0;
	if (oldScrollY != scrollY) {
		//if (audioLoaded && !audioControl.paused) disableAutoscroll();
		canvasMove = true;
	}
	clickX = mouseX;
	clickY = mouseY;
}

function handleKeyPress(key) 
{
	dragging = false;
	if (!audioLoaded && key==32) {
	  touchStart();
	  return;
        }
	if (!drawCmds) return;

	if (String.fromCharCode(key) == "A") {
		$("#asImg")[0].hidden = !$("#asImg")[0].hidden;
		$("#nasImg")[0].hidden = !$("#nasImg")[0].hidden;
		$("#asSpan")[0].title = "Auto-Scroll is currently " + ($("#asImg")[0].hidden ? "OFF" : "ON");
	}

	if (String.fromCharCode(key) == " " && audioLoaded) {
		if (audioControl.paused) audioControl.play();
		else audioControl.pause();
	}
	
	var oldScrollY = scrollY;

   if (String.fromCharCode(key) == "F") toggleFullScreen();
   if (String.fromCharCode(key) == "S") toggleCaptions();
 	
	if (key == 38) {
		scrollY -= 0.25 * canvasScreen.width;
		if (scrollY < 0) scrollY = 0;
		if (oldScrollY != scrollY) { 
			if (audioLoaded && !audioControl.paused) disableAutoscroll();
			canvasMove = true; 
		}
	}

	if (key == 33) {
		scrollY -=  canvasScreen.width;;
		if (scrollY < 0) scrollY = 0;
		if (oldScrollY != scrollY) { 
			if (audioLoaded && !audioControl.paused) disableAutoscroll();
			canvasMove = true; 
		}
	}
	
	if (key == 40) {
		scrollY += 0.25 * canvasScreen.width;;
		if (scrollY + canvasScreen.height > canvasFull.height) scrollY = canvasFull.height - canvasScreen.height;
		if (scrollY < 0) scrollY = 0;
		if (oldScrollY != scrollY) { 
			if (audioLoaded && !audioControl.paused) disableAutoscroll();
			canvasMove = true; 
		}
	}
	
	if (key == 34) {
		scrollY += canvasScreen.width;
		if (scrollY + canvasScreen.height > canvasFull.height) scrollY = canvasFull.height - canvasScreen.height;
		if (scrollY < 0) scrollY = 0;
		if (oldScrollY != scrollY) { 
			if (audioLoaded && !audioControl.paused) disableAutoscroll();
			canvasMove = true; 
		}
	}
	
	if (key == 27 && !volumeDiv.hidden) toggleVolumeControl();
	
	if (key == 187 && audioLoaded && !$("#muteImg")[0].hidden) {
		var v = audioControl.volume;
		v = v+0.1;
		if (v > 1) v = 1;
		audioControl.volume = v;
		$("#muteImg")[0].title = "Volume: " + Math.round(audioControl.volume * 100) + "%";
		if (volumeDiv.hidden) toggleVolumeControl();
		window.requestAnimationFrame(drawVolume);
//		e.preventDefault();
	}

	if (key == 189 && audioLoaded && !$("#muteImg")[0].hidden) {
		var v = audioControl.volume;
		v = v-0.1;
		if (v < 0) v = 0;
		audioControl.volume = v;
		$("#muteImg")[0].title = "Volume: " + Math.round(audioControl.volume * 100) + "%";
		if (volumeDiv.hidden) toggleVolumeControl();
		window.requestAnimationFrame(drawVolume);
//		e.preventDefault();
	}
	
	if (key == 188 && captionMode) {
		captionSize++;
		captionText.innerHTML = "Caption font size decreased";
		captionDiv.hidden = false;
		captionTime = clockNow();
		$("#captionDiv").css("font-size", (canvasScreen.width / captionSize) + "px");
	}
	if (key == 190 && captionMode && captionSize > 10) {
		captionSize--;
		captionText.innerHTML = "Caption font size increased";
		captionDiv.hidden = false;
		captionTime = clockNow();
		$("#captionDiv").css("font-size", (canvasScreen.width / captionSize) + "px");
	} 

}

function eventAudioError(e)
{
	var s;
	if (e.target.error.code == e.target.error.MEDIA_ERR_ABORTED) s = "Audio playback aborted.";
	else if (e.target.error.code == e.target.error.MEDIA_ERR_NETWORK) s = "Audio download failed due to network error.";
	else if (e.target.error.code == e.target.error.MEDIA_ERR_DECODE) s = "Audio decoding problem (e.g., corrupt file, or using unsupported features).";
	else if (e.target.error.code == e.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED) s = "Audio download failed or unsupported file format.";
	else s = "Audio playback failed.";
	setErrorMode(s);
}

function eventVideoError(a,b,c)
{
	setErrorMode("Download of video data failed.<br>(possibly due to same-origin issues if the video data is hosted elsewhere)");
}

function eventCanvasKeydown(e) 
{
	var key = e.keyCode ? e.keyCode : e.which ? e.which : e.charCode;
	handleKeyPress(key);
//		e.preventDefault();  I don't think this is needed with any key...
}

function setPointerDivSize()
{
	var factor;
	if (canvasScreen.width >= 1000) factor = 1.0;
	else if (canvasScreen.width < 300) factor = 0.50;
	else factor = 0.50 * (canvasScreen.width - 300) / 700 + 0.50;
	pointerDiv.width = pointerImg.width * factor;
	pointerDiv.height = pointerImg.height * factor;
	pointerCanvas.getContext("2d").clearRect(0, 0, pointerCanvas.width, pointerCanvas.height);
	pointerCanvas.getContext("2d").drawImage(pointerImg, 0, 0, pointerImg.width, pointerImg.height,
										     0, 0, pointerDiv.width, pointerDiv.height);	
}

function resizeCanvas(e) 
{
	if (0 && browserIsIos) {
		// increase height to get rid off ios address bar
		// I think this needs fixing...
		$("#container").height($(window).height() + 60)
		setTimeout(function() { window.scrollTo(0, 1); }, 100);
	}
	
	if (!volumeDiv.hidden) {
		draggingVolume = false;
		volumeDiv.hidden = true;
	}
	
	var width = $("#container").width();
	var height = $("#container").height();
	
	$("#captionDiv").css("font-size", (width / captionSize) + "px");
	
	$("#asText")[0].hidden = width < 480;
	$("#prevText")[0].hidden = width < 480;
	
	var scaledScrollY = scrollY / canvasScreen.width;
	canvasScreen.width = width;
	canvasScreen.height = height - 21;
	$("#errorDiv").width($("#container").width());
	$("#errorDiv").height($("#container").height()-20);
	scrollY = scaledScrollY * canvasScreen.width;
	if (canvasFull) {
		canvasFull.width = width;
		canvasFull.height = maxY * width;
		contextFull = canvasFull.getContext("2d");
		if (scrollY > canvasFull.height - canvasScreen.height) scrollY = canvasFull.height - canvasScreen.height;
		if (scrollY < 0) scrollY = 0;
		$("#asBlock")[0].hidden = canvasFull.height < canvasScreen.height;
	}
	
	if (pointerDiv) pointerDiv.hidden = true;
	setPointerDivSize();
	
	drawReset = true;
}

// Slow down firing of resize events
var resizeTimeout;
$(window).resize(function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(resizeCanvas, 100);
});

function orientationChange() 
{
	// Nothing to do here really...	
}

// Slow down firing of orientation changes
var otimeout;
window.onorientationchange = function() {
    clearTimeout(otimeout);
    otimeout = setTimeout(orientationChange, 50);
}

function handleMouseWheel(e) {
    if(e.originalEvent.wheelDelta > 0)
		handleKeyPress(38);
    else
		handleKeyPress(40);
}

function touchStart(e)
{
 if (!audioLoaded) { 
 audioLoaded = true; 
 audioMetaDataLoaded = true; 
 phaseTwoLoading(); 
 phaseThreeLoading();
 audioControl.play();
e.preventDefault(); 
 } 
}

function launch(target)
{
	var okVars = true;
	
	oldState = {
		canvasFull: canvasFull,
		contextFull: contextFull,
		drawCmds: drawCmds,
		refCmds: refCmds,
		transcript: transcript,
		captionsAvailable: captionsAvailable,
		curDrawIdx: curDrawIdx,
		scrollY: scrollY,
		maxY: maxY,
		pointerLastTime: pointerLastTime,
		pointerLastX: pointerLastX,
		pointerLastY: pointerLastY,
		audio: audioControl
	};
	stateStack.push(oldState);

	clearErrorMode();
	
	// Start downloads
	var urlVars = getUrlVars(target);
	
	if (!urlVars.audio || !urlVars.video) {
		var s = "audio or video";
		if (urlVars.video) s = "audio";
		if (urlVars.audio) s = "video"; 
		setErrorMode("No " + s + " data specified in URL.<br><br>Usage: wlsviewer.html?audio=A&video=V<br>where A and V are URLs of audio (.mp3, etc.) and video (.lsv) data.");
		okVars = false;
	} else {
		$("#loadImg")[0].hidden = browserIsIos;
		$("#loadingVideoSpan")[0].innerHTML = "Loading video data...";
	}
	
	drawCmds = false;
	refCmds = [];
	transcript = [];

	$("#playImg")[0].hidden = !browserIsIos;
	$("#pauseImg")[0].hidden = true;
	$("#progressBar")[0].hidden = true;
	$("#disableWhileLoadingVideo")[0].hidden = true;
	$("#asBlock")[0].hidden = true;
	$("#loadingVideoSpan")[0].hidden = false;

	audioLoaded = false;
	audioMetaDataLoaded = false;
//	newAudioControl.type = "audio/wav";
	audioControl.pause();
//	audioControl.hidden = true;
//	$("#audioContainer")[0].insertBefore(newAudioControl, audioControl);
//	audioControl = newAudioControl;
	
	if (curDrawRequest) curDrawRequest.abort();
	videoPctLoaded = -1;

	scrollY = 0;
	dragging = false;
	draggingAudio = false;
	draggingVolume = false;
	drawReset = false;
	canvasFull = false;
	curDrawIdx = 0;
	animStart = -1;	

	$("#prevBlock")[0].hidden = stateStack.length == 1;

	if (okVars) {
		curDrawRequest = $.ajax({
			url: urlVars.video,
			dataTyle: 'json',
			success: loadedVideoData,
			error: eventVideoError,
			progress: function(e) { 
				if (e.lengthComputable) {
					videoPctLoaded = Math.round((e.loaded / e.total) * 100); 
					if (audioLoaded) $("#loadingVideoSpan")[0].innerHTML = "Audio Loaded.  Loading video data... [" + videoPctLoaded + "%]";
					else $("#loadingVideoSpan")[0].innerHTML = "Loading video data... [" + videoPctLoaded + "%]'";
				}
			}		
		});
	}
	if (okVars) audioControl.src = urlVars.audio;

	captionDiv.hidden = true;
	resizeCanvas();
}

function goBack()
{
	if (stateStack.length == 1) {
		alert ("Can't go back!");
		return;
	}

	clearErrorMode();
	
	if (curDrawRequest) curDrawRequest.abort();
	oldState = stateStack[stateStack.length-1];
	
	canvasFull = oldState.canvasFull;
	contextFull = oldState.contextFull;
	drawCmds = oldState.drawCmds;
	refCmds = oldState.refCmds;
	transcript = oldState.transcript;
	captionsAvailable = oldState.captionsAvailable; 
	$("#ccImg")[0].title = captionsAvailable ? "Toggle closed captioning" : "Closed captioning not available for this video";
	curDrawIdx = oldState.curDrawIdx;
	scrollY = oldState.scrollY;
	maxY = oldState.maxY;
	pointerLastTime = oldState.pointerLastTime;
	pointerLastX = oldState.pointerLastX;
	pointerLastY = oldState.pionterLastY;
	
	audioLoaded = true;
	audioControl.pause();
	audioControl.autoplay = false;
	audioControl.hidden = true;
	v = audioControl.volume;
	$("#audioContainer")[0].removeChild(audioControl);
	audioControl = oldState.audio;
	audioControl.volume = v;
	
	$("#loadImg")[0].hidden = true;
	$("#progressBar")[0].hidden = false;
	$("#disableWhileLoadingVideo")[0].hidden = false;
	$("#loadingVideoSpan")[0].hidden = true;
	
	stateStack.pop();
	
	dragging = false;
	draggingAudio = false;
	draggingVolume = false;
	drawReset = false;
	animStart = -1;
	
	$("#prevBlock")[0].hidden = stateStack.length == 1;
	resizeCanvas();
}

function eventClickAutoScroll()
{
	$("#asImg")[0].hidden = !$("#asImg")[0].hidden;
	$("#nasImg")[0].hidden = !$("#nasImg")[0].hidden;
	$("#asSpan")[0].title = "Auto-Scroll is currently " + ($("#asImg")[0].hidden ? "OFF" : "ON");	
}

function drawVolume()
{
	var ctx = volumeCanvas.getContext("2d");
	ctx.clearRect(0,0,40,100);
	var v = audioControl.volume;
	ctx.fillStyle = "#aaa";
	ctx.beginPath();
	ctx.moveTo(10,90);
	ctx.lineTo(10,90 - v * 80);
	ctx.lineTo(10+20 * v,90 - v * 80);
	ctx.closePath();
	ctx.fill();
	ctx.strokeStyle = "#eee";
	ctx.beginPath();
	ctx.moveTo(10,10);
	ctx.lineTo(10,90);
	ctx.lineTo(30,10);
	ctx.lineTo(10,10);
	ctx.stroke();
	ctx.beginPath();
	ctx.moveTo(5,90 - v * 80);
	ctx.lineTo(15+20 * v,90 - v * 80);
	ctx.stroke();
	if (Math.round(v*100) < 100) {
		ctx.fillStyle = "#eee";
		ctx.font = "10px Arial";
		ctx.textAlign="right";
		ctx.fillText(Math.round(v*100)+"%", 37, 90);
	}
}

function toggleVolumeControl()
{
	volumeDiv.hidden = !volumeDiv.hidden;
	if (volumeDiv.hidden) {
		draggingVolume = false;
		return;
	}
	volumeDiv.style.left = ($("#muteImg").offset().left - 5) + "px";
	volumeDiv.style.top = ($("#muteImg").offset().top - 110) + "px";
	volumeDivTime = clockNow();
	window.requestAnimationFrame(drawVolume);
}

function eventVolumeMouseDown(e)
{
	draggingVolume = true;
	volumeDivTime = clockNow();
	eventVolumeMouseMove(e);
}

function eventVolumeMouseUp(e)
{
	volumeDivTime = clockNow();	
	draggingVolume = false;
}

function eventVolumeMouseMove(e)
{
	volumeDivTime = clockNow();
	if (!draggingVolume) return;
	var rect = volumeCanvas.getBoundingClientRect();
	var mouseY = e.pageY - rect.top;
	if (mouseY > 90) mouseY = 90;
	if (mouseY < 10) mouseY = 10;
	audioControl.volume = 1 - (mouseY-10) / 80;
	$("#muteImg")[0].title = "Volume: " + Math.round(audioControl.volume * 100) + "%";
	window.requestAnimationFrame(drawVolume);
}

function eventAudioMouseDown(e)
{
	if (!volumeDiv.hidden) volumeDiv.hidden = true;
	if (audioLoaded) {
		draggingAudio = true;
		pausedBeforeDragging = audioControl.paused;
		audioControl.pause();
		eventAudioMouseMove(e);
	}
}

function eventAudioMouseUp()
{
	if (draggingAudio) {
		if (!pausedBeforeDragging && audioControl.currentTime < audioControl.duration) audioControl.play();
		draggingAudio = false;
	}
}

function eventAudioMouseMove(e)
{
	if (!draggingAudio) return;
	var rect = canvasAudio.getBoundingClientRect();
	var mouseX = e.pageX - rect.left;
	if (mouseX > canvasAudio.width-10) mouseX = canvasAudio.width-10;
	if (mouseX < 0) mouseX = 0;
	audioControl.currentTime = mouseX * audioControl.duration / (canvasAudio.width-10);
	window.requestAnimationFrame(drawAudio);
}

function toggleCaptions()
{
	if (!captionsAvailable)
		captionText.innerHTML = "Closed captions not available for this video";
	else {
		captionMode = !captionMode;
		captionText.innerHTML = "Closed captions turned " + (captionMode ? "ON<br>Press < or > to change font size" : "OFF");
	}	
	captionTime = clockNow();
	captionDiv.hidden = false;
}

function touchHandler(event)
{
    var touches = event.changedTouches,
        first = touches[0],
        type = "";
    switch(event.type)
    {
        case "touchstart": type = "mousedown"; break;
        case "touchmove":  type="mousemove"; break;        
        case "touchend":   type="mouseup"; break;
        default: return;
    }

             //initMouseEvent(type, canBubble, cancelable, view, clickCount, 
    //           screenX, screenY, clientX, clientY, ctrlKey, 
    //           altKey, shiftKey, metaKey, button, relatedTarget);

    var simulatedEvent = document.createEvent("MouseEvent");
    simulatedEvent.initMouseEvent(type, true, true, window, 1, 
                              first.screenX, first.screenY, 
                              first.clientX, first.clientY, false, 
                              false, false, false, 0/*left*/, null);

    first.target.dispatchEvent(simulatedEvent);
    event.preventDefault();
}

function init()
{
	browserIsIos = navigator.userAgent.match(/(iPhone)|(iPod)/); // is iPhone
	if (browserIsIos) {
	   $("#muteBlock")[0].hidden = true;
	}

	captionDiv = $("#captionDiv")[0];
	captionText = $("#captionText")[0];
	
	volumeDiv = $("#volumeDiv")[0];
	volumeCanvas = $("#volumeCanvas")[0];
	volumeCanvas.addEventListener("mousedown", eventVolumeMouseDown);
	volumeCanvas.addEventListener("mouseup", eventVolumeMouseUp);
	volumeCanvas.addEventListener("mouseout", eventVolumeMouseUp);
	volumeCanvas.addEventListener("mousemove", eventVolumeMouseMove);
	
	pointerDiv = $("#pointerDiv")[0];
	pointerCanvas =	$("#pointerCanvas")[0];
	pointerImg = $("#pointerImg")[0];
	pointerCanvas.width = pointerImg.width;
	pointerCanvas.height = pointerImg.height;
	
	document.body.addEventListener("keydown", eventCanvasKeydown);
	$(window).bind('mousewheel', handleMouseWheel);
	
	canvasScreen = $("#myCanvas")[0];
	contextScreen = canvasScreen.getContext("2d");
	canvasScreen.addEventListener("mousedown", eventCanvasMouseDown);
	canvasScreen.addEventListener("mouseup", eventCanvasMouseUp);
	canvasScreen.addEventListener("mouseout", eventCanvasMouseUp);
	canvasScreen.addEventListener("mousemove", eventCanvasMouseMove);
	canvasScreen.addEventListener("touchmove", eventCanvasMouseMove);
	$("#asSpan")[0].addEventListener("click", eventClickAutoScroll);
	$("#prevSpan")[0].addEventListener("click", goBack);

	canvasScreen.addEventListener("touchstart", touchHandler, true);
    canvasScreen.addEventListener("touchmove", touchHandler, true);
    canvasScreen.addEventListener("touchend", touchHandler, true);
    canvasScreen.addEventListener("touchcancel", touchHandler, true);    
	
	canvasAudio = $("#progressBar")[0];
	canvasAudio.addEventListener("mousedown", eventAudioMouseDown);
	canvasAudio.addEventListener("mouseup", eventAudioMouseUp);
	canvasAudio.addEventListener("mouseout", eventAudioMouseUp);
	canvasAudio.addEventListener("mousemove", eventAudioMouseMove);
	contextAudio = canvasAudio.getContext("2d");
	
	audioControl = $("#audioControl")[0];
	audioControl.addEventListener("seeked", eventAudioSeeked);	
	audioControl.addEventListener("loadedmetadata", eventAudioLoadedMetaData);	
	audioControl.addEventListener("canplaythrough", eventAudioCanPlayThrough);	
	audioControl.addEventListener("play", eventAudioPlay);	
	audioControl.addEventListener("pause", eventAudioPause);	
	audioControl.addEventListener("error", eventAudioError);	
	document.addEventListener("touchstart", touchStart);
	audioControl.autoplay = false;
	audioControl.preload = "auto";
	$("#errorDiv").width($("#container").width());
	$("#errorDiv").height($("#container").height()-20);
	
	setInterval(tick, 50);

	launch(window.location.href);
}

$(document).ready(init); 
</script>

	</body>
</html>
